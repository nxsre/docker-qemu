variables:
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_CERT_PATH: "/certs/client"
  DOCKER_TLS: 'true'
  DOCKER_HOST: tcp://docker:2376/
  DOCKER_DRIVER: overlay2
  BUILDKIT_INLINE_CACHE: '1'

stages:
  - test
  - publish

.init:
  image: ixdotai/docker-buildx-qemu:latest
  services:
    - docker:dind
  before_script:
    - update-binfmts --enable # Important: Ensures execution of other binary formats is enabled in the kernel
    - export BUILDX_NAME="buildx-$(tr -cd '[:alnum:]' < /dev/urandom | fold -w6 | head -n1)"
    - docker context create "${BUILDX_NAME}"
    - docker buildx create --name "${BUILDX_NAME}" --use "${BUILDX_NAME}"
    - docker buildx inspect --bootstrap
    - mkdir -p ~/.docker
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "${CI_REGISTRY_USER}" --password-stdin "${CI_REGISTRY}"


{% for version in versions %}
build:{{ versions[version].version }}:
  extends:
    - .init
  stage: test
  except:
    refs:
      - master
  script:
    - |
        set -exu; \
        docker buildx build \
        --platform={{ target_platform }} \
        --progress=plain \
        --pull \
        --push \
        --cache-from=${CI_REGISTRY_IMAGE}:cache-{{ versions[version].major }}.{{ versions[version].minor }}.{{ versions[version].patch }} \
        --cache-to=${CI_REGISTRY_IMAGE}:cache-{{ versions[version].major }}.{{ versions[version].minor }}.{{ versions[version].patch }} \
        --tag "${CI_REGISTRY_IMAGE}:{{ versions[version].major }}.{{ versions[version].minor }}.{{ versions[version].patch }}${CI_PIPELINE_ID}" \
        {{ versions[version].major }}.{{ versions[version].minor }}/
{% endfor %}

{%- for version in versions %}
publish:{{ versions[version].version }}:
  extends:
    - .init
  stage: publish
  only:
    refs:
      - master
  script:
    - |
        set -exu; \
        docker buildx build \
        --platform={{ target_platform }} \
        --progress=plain \
        --pull \
        --cache-from=${CI_REGISTRY_IMAGE}:cache-{{ versions[version].major }}.{{ versions[version].minor }}.{{ versions[version].patch }} \
        --cache-to=${CI_REGISTRY_IMAGE}:cache-{{ versions[version].major }}.{{ versions[version].minor }}.{{ versions[version].patch }} \
        --tag "${CI_REGISTRY_IMAGE}:{{ versions[version].major }}.{{ versions[version].minor }}.{{ versions[version].patch }}" \
        --tag "${CI_REGISTRY_IMAGE}:{{ versions[version].major }}.{{ versions[version].minor }}" \
{%- if versions[version].get('latest') %}
        --tag "${CI_REGISTRY_IMAGE}:latest" \
{%- endif %}
        --push {{ versions[version].major }}.{{ versions[version].minor }}/
{% endfor %}
